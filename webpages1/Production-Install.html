<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Production-Install</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
    }
    .header {
      background-color: #337ab7;
      color: white;
      padding: 15px;
      font-size: 24px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 999;
    }
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      width: 250px;
      bottom: 0;
      padding: 20px;
      background-color: #fafafa;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      z-index: 998;
    }
    .content {
      margin-top: 70px;
      margin-left: 320px;
      padding: 20px;
    }
    .sidebar-root {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .sidebar-page, .sidebar-h1 {
      margin-bottom: 6px;
    }
    .sidebar-toggle {
      cursor: pointer;
      font-weight: bold;
      margin-right: 5px;
      color: #555;
    }
    .h1-list, .h2-list {
      list-style: none;
      margin: 0 0 0 15px;
      padding: 0;
      display: none; /* Keep sidebar collapsed */
    }
    a {
      text-decoration: none;
      color: #337ab7;
    }
    a:hover {
      text-decoration: underline;
    }
    .h2-toggle {
      cursor: pointer;
      border: none;
      background: none;
      font-size: 18px;
      font-weight: bold;
      margin-right: 5px;
    }
    .collapsible-section {
      display: block; /* Expand all H2 sections by default */
      margin-left: 20px;
    }
    pre code {
      background-color: #f0f0f0;
      padding: 5px;
      display: block;
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="header">Production-Install</div>
  <div class="sidebar"><ul class="sidebar-root"><li class="sidebar-page"><span class="sidebar-toggle">+ </span><a href="Home.html">Home</a><ul class="h1-list" style="display:none;"><li class="sidebar-h1"><a href="Home.html#i2b2-documentation">i2b2 Documentation</a></li></ul></li><li class="sidebar-page"><span class="sidebar-toggle">+ </span><a href="Quick-Start.html">Quick-Start</a><ul class="h1-list" style="display:none;"><li class="sidebar-h1"><span class="sidebar-toggle">+ </span><a href="Quick-Start.html#quick-start---demo-install-guide">Quick Start - Demo install Guide</a><ul class="h2-list" style="display:none;"><li class="sidebar-h2"><a href="Quick-Start.html#prerequisites">Prerequisites</a></li><li class="sidebar-h2"><a href="Quick-Start.html#installation-instructions">Installation Instructions</a></li><li class="sidebar-h2"><a href="Quick-Start.html#troubleshooting-guide">Troubleshooting Guide</a></li><li class="sidebar-h2"><a href="Quick-Start.html#fresh-installation">Fresh Installation</a></li></ul></li></ul></li><li class="sidebar-page"><span class="sidebar-toggle">+ </span><a href="Production-Install.html">Production-Install</a><ul class="h1-list" style="display:none;"><li class="sidebar-h1"><span class="sidebar-toggle">+ </span><a href="Production-Install.html#i2b2-production-deployment-guide">i2b2 Production Deployment Guide</a><ul class="h2-list" style="display:none;"><li class="sidebar-h2"><a href="Production-Install.html#1.-setting-up-subnets-in-the-cloud">1. Setting up Subnets in the Cloud</a></li><li class="sidebar-h2"><a href="Production-Install.html#2.-setting-up-postgresql-database">2. Setting up PostgreSQL Database</a></li><li class="sidebar-h2"><a href="Production-Install.html#3.-deploying-i2b2-client-containers-and-connecting-to-the-production-database">3. Deploying i2b2 Client Containers and Connecting to the Production Database</a></li><li class="sidebar-h2"><a href="Production-Install.html#4.-custom-configuration">4. Custom Configuration</a></li></ul></li></ul></li><li class="sidebar-page"><span class="sidebar-toggle">+ </span><a href="i2b2-Upgrade.html">i2b2-Upgrade</a><ul class="h1-list" style="display:none;"><li class="sidebar-h1"><span class="sidebar-toggle">+ </span><a href="i2b2-Upgrade.html#i2b2-upgrade-guide">i2b2 Upgrade Guide</a><ul class="h2-list" style="display:none;"><li class="sidebar-h2"><a href="i2b2-Upgrade.html#step-1:-navigate-to-the-i2b2-docker-directory">Step 1: Navigate to the i2b2-docker Directory</a></li><li class="sidebar-h2"><a href="i2b2-Upgrade.html#step-2:-checkout-the-new-release-branch">Step 2: Checkout the New Release Branch</a></li><li class="sidebar-h2"><a href="i2b2-Upgrade.html#step-3:-stop-running-containers">Step 3: Stop Running Containers</a></li><li class="sidebar-h2"><a href="i2b2-Upgrade.html#step-4:-pull-the-latest-images">Step 4: Pull the Latest Images</a></li><li class="sidebar-h2"><a href="i2b2-Upgrade.html#step-5:-start-the-updated-containers">Step 5: Start the Updated Containers</a></li><li class="sidebar-h2"><a href="i2b2-Upgrade.html#step-6:-wait-for-initialization">Step 6: Wait for Initialization</a></li></ul></li></ul></li><li class="sidebar-page"><span class="sidebar-toggle">+ </span><a href="i2b2-Admin-Module.html">i2b2-Admin-Module</a><ul class="h1-list" style="display:none;"><li class="sidebar-h1"><a href="i2b2-Admin-Module.html#i2b2-administration-module-guide">i2b2 Administration Module Guide</a></li></ul></li></ul></div>
  <div class="content"><div><h1 id="i2b2-production-deployment-guide">i2b2 Production Deployment Guide</h1><p>This guide provides step-by-step instructions for deploying i2b2 in a production environment using Docker, connected to a PostgreSQL database on a remote production server.</p><hr/><h2 id="1.-setting-up-subnets-in-the-cloud"><button class="h2-toggle">+</button>1. Setting up Subnets in the Cloud</h2><div class="collapsible-section" style="display:none;"><p>Ensure appropriate cloud subnets and security groups are configured to allow communication between the application containers and the production PostgreSQL database. Follow your cloud providerâ€™s documentation to:</p><ul>
<li>Create private and public subnets</li>
<li>Configure routing tables</li>
<li>Set up security groups to allow traffic on necessary ports (e.g., PostgreSQL default 5432, i2b2 web client port)</li>
</ul><hr/></div><h2 id="2.-setting-up-postgresql-database"><button class="h2-toggle">+</button>2. Setting up PostgreSQL Database</h2><div class="collapsible-section" style="display:none;"><p>Refer to the official i2b2 Data Installation Guide to prepare the PostgreSQL database schemas and users:</p><p><a href="https://community.i2b2.org/wiki/display/getstarted/Chapter+3.+Data+Installation">i2b2 Data Installation Guide</a></p><hr/></div><h2 id="3.-deploying-i2b2-client-containers-and-connecting-to-the-production-database"><button class="h2-toggle">+</button>3. Deploying i2b2 Client Containers and Connecting to the Production Database</h2><div class="collapsible-section" style="display:none;"><p>This section details how to deploy the i2b2 web client and Core Server using Docker, and connect them to the pre-configured PostgreSQL production database.</p><h3>Step 1: Clone the i2b2 Docker Repository</h3><pre class="codehilite"><code class="language-bash">git clone https://github.com/i2b2/i2b2-docker.git
</code></pre><h3>Step 2: Navigate into the Cloned Directory</h3><pre class="codehilite"><code class="language-bash">cd i2b2-docker
</code></pre><h3>Step 3: Checkout the Production Configuration Branch</h3><pre class="codehilite"><code class="language-bash">git checkout release-v1.8.1a.0001_prod_db
</code></pre><h3>Step 4: Configure the Environment Variables</h3><p>Edit the <code>.env</code> file and update the following fields with your production database configuration:</p><ul>
<li><code>DB_HOST</code></li>
<li><code>DB_PORT</code></li>
<li><code>DB_USERNAME</code></li>
<li><code>DB_PASSWORD</code></li>
<li><code>DB_NAME</code></li>
<li><code>DB_SCHEMA_NAME</code></li>
</ul><h3>Step 5: Start the Web Client and Core Server Containers</h3><pre class="codehilite"><code class="language-bash">docker-compose up -d i2b2-webclient
</code></pre><h3>Step 6: Verify Deployment</h3><p>Check container logs to verify successful startup:</p><pre class="codehilite"><code class="language-bash">docker-compose logs i2b2-core-server
</code></pre><p>Then access the i2b2 web client using the production URL and port.</p><hr/></div><h2 id="4.-custom-configuration"><button class="h2-toggle">+</button>4. Custom Configuration</h2><div class="collapsible-section" style="display:none;"><h3>Update Database Lookup Tables in <code>i2b2hive</code></h3><p>Run the following SQL statements to map the i2b2 services to correct schemas:</p><pre class="codehilite"><code class="language-sql">UPDATE crc_db_lookup SET c_db_fullschema = 'i2b2demodata';
UPDATE work_db_lookup SET c_db_fullschema = 'i2b2workdata';
UPDATE ont_db_lookup SET c_db_fullschema = 'i2b2metadata';
</code></pre><h3>Update Core Server URL in the Database</h3><p>In the PM schema, update the <code>PM_CELL_DATA</code> table to reflect the production server URL.</p><p>Replace any instance of:</p><pre class="codehilite"><code>http://localhost:9090/
</code></pre><p>With:</p><pre class="codehilite"><code>http://$I2B2_CORE_SERVER_HOST:$I2B2_CORE_SERVER_PORT/
</code></pre><p>Refer to this SQL file for examples:</p><p><a href="https://github.com/i2b2/i2b2-data/blob/master/edu.harvard.i2b2.data/Release_1-8/NewInstall/Pmdata/scripts/demo/pm_access_insert_data.sql">pm_access_insert_data.sql</a></p><hr/><h3>Update the Web Client Configuration</h3><p>Access the running web client container and modify the configuration files:</p><pre class="codehilite"><code class="language-bash">docker exec -it i2b2-webclient bash
cd /var/www/html/webclient/
</code></pre><h4>1. Edit i2b2_config_domains.json</h4><pre class="codehilite"><code class="language-bash">vi i2b2_config_domains.json
</code></pre><p><small>Update:</small></p><ul>
<li><code>"urlProxy": Replace "/~proxy" with "proxy.php"</code></li>
<li><code>"urlCellPM": Replace default URL with "http://$I2B2_CORE_SERVER_HOST:$I2B2_CORE_SERVER_PORT/i2b2/services/PMService/"</code></li>
</ul><h4>2. Update proxy.php</h4><pre class="codehilite"><code class="language-bash">vi proxy.php
</code></pre><p><small>Whitelist URL:</small></p><p><small>replace this URL <code>http://services.i2b2.org/i2b2/services/PMService/</code> with following</small></p><pre class="codehilite"><code class="language-php">http://$I2B2_CORE_SERVER_HOST:$I2B2_CORE_SERVER_PORT/i2b2/services/PMService/
</code></pre><p>Example for quick-start:</p><pre class="codehilite"><code>http://i2b2-wildfly:8080/i2b2/services/PMService/
</code></pre><p><small>Replace <code>127.0.0.1:8080</code> with <code>$I2B2_CORE_SERVER_HOST:$I2B2_CORE_SERVER_PORT</code></small></p><h4>3. Update Proxy Configuration in-place</h4><pre class="codehilite"><code class="language-bash">sed -i 's#127.0.0.1:8080/#$I2B2_CORE_SERVER_HOST:$I2B2_CORE_SERVER_PORT/#g' proxy.php
sed -i 's#http://services.i2b2.org#http://$I2B2_CORE_SERVER_HOST:$I2B2_CORE_SERVER_PORT#g' proxy.php
</code></pre><p><small> This will update the ProxyPass and ProxyPassReverse.</small></p><p><small>Now restart the apache2 service </small></p><pre class="codehilite"><code class="language-bash">docker exec -it i2b2-webclient bash -c "service apache2 restart" 
</code></pre><hr/><h3>Deployment Complete</h3><p>You have successfully deployed i2b2 in a production environment. For any troubleshooting, consult the container logs and official documentation.</p></div></div></div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var toggles = document.querySelectorAll(".sidebar-toggle");
      toggles.forEach(function(toggle) {
        var ul = toggle.parentElement.querySelector("ul");
        toggle.addEventListener("click", function() {
          if (ul) {
            if (ul.style.display === "none" || ul.style.display === "") {
              ul.style.display = "block";
              toggle.textContent = "- ";
            } else {
              ul.style.display = "none";
              toggle.textContent = "+ ";
            }
          }
        });
      });

      var h2Toggles = document.querySelectorAll(".h2-toggle");
      h2Toggles.forEach(function(btn) {
        var collapsible = btn.parentNode.nextElementSibling;
        if (collapsible && collapsible.classList.contains("collapsible-section")) {
          collapsible.style.display = "block"; // Expand all H2 sections
          btn.textContent = "-"; // Update toggle button
        }
        btn.addEventListener("click", function() {
          if (collapsible.style.display === "none") {
            collapsible.style.display = "block";
            btn.textContent = "-";
          } else {
            collapsible.style.display = "none";
            btn.textContent = "+";
          }
        });
      });

      function expandSectionFromHash() {
        if (window.location.hash) {
          var targetId = window.location.hash.substring(1); 
          var targetElement = document.getElementById(targetId);
          if (targetElement) {
            var collapsible = targetElement.nextElementSibling;
            if (collapsible && collapsible.classList.contains("collapsible-section")) {
              collapsible.style.display = "block";
              var toggleBtn = targetElement.querySelector(".h2-toggle");
              if (toggleBtn) toggleBtn.textContent = "-";
              
              setTimeout(function() {
                var headerHeight = document.querySelector(".header").offsetHeight;
                var elementPosition = targetElement.getBoundingClientRect().top + window.scrollY;
                window.scrollTo({ top: elementPosition - headerHeight - 10, behavior: "smooth" });
              }, 100);
            }
          }
        }
      }

      expandSectionFromHash();
      window.addEventListener("hashchange", expandSectionFromHash);

      var currentPage = window.location.pathname.split("/").pop();
      var links = document.querySelectorAll(".sidebar a");
      links.forEach(function(link) {
        if (link.getAttribute("href") === currentPage) {
          link.style.fontWeight = "bold";
          var parent = link.closest("ul");
          while (parent && parent.classList.contains("h1-list")) {
            parent.style.display = "block";
            var toggle = parent.previousElementSibling.querySelector(".sidebar-toggle");
            if (toggle) toggle.textContent = "- ";
            parent = parent.parentElement.closest("ul");
          }
        }
      });
    });

    document.querySelectorAll('h2').forEach((el, i) => {
    const marker = document.createElement('div');
    marker.textContent = `###H2###-${el.innerText}`;
    marker.style.fontSize = '0px';
    marker.style.color = 'white';
    marker.style.position = 'relative';
    el.parentNode.insertBefore(marker, el);
  });

  
  </script>
</body>
</html>